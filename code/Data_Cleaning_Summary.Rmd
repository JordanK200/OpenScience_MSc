---
title: "Dataset_Summary"
author: "Jordan Katchen"
date: "2025-11-13"
output: html_document
---

# Library
```{r}
library(tidyverse)
library(rcrossref)
library(readxl)
library(textclean)
library(humaniformat)
library(googledrive)
library(here)
```

# Data Download

Data can be found: https://drive.google.com/drive/folders/1FSxIsOkGuVqUTiFzEPaC4xpr_r5OvzNJ?usp=sharing
```{r}
# --- Define Files ---
# For each file: Google Drive ID and local path
files <- list(
  list(id = "https://drive.google.com/file/d/1JPSHpU8EMPeviTDvPFmbX4Nua6gcUcd4/view?usp=sharing", path = here("data", "RAW_PLOS.csv")),
  list(id = "https://drive.google.com/file/d/1v9Ho0FVOsazANgoNBgFRqKMzxdUwiTwy/view?usp=sharing", path = here("data", "RAW_PLOS_Comparator.csv")),
  list(id = "https://drive.google.com/file/d/1njKEhlUaej68Lf0ltiJJaJtRp6AVfoOh/view?usp=share_link", path = here("data", "RAW_NSERC.csv")),
  list(id = "https://drive.google.com/file/d/1OV9Mkem4QvyYYZAHtP1IEHIRU7s2Sww9/view?usp=sharing", path = here("data", "RAW_CIHR.csv"))
)

# Use deauth() so public files can be downloaded without logging in
drive_deauth()

# Now download files
walk(files, ~{
  if (!file.exists(.x$path)) {
    message("Downloading: ", .x$path)
    drive_download(as_id(.x$id), path = .x$path, overwrite = FALSE)
  } else {
    message("Already exists: ", .x$path)
  }
})

rm(files) # Removing files list
```

# PLOS Data

Load the PLOS cleaning function which can be found in the code directory.
```{r}
source(here("code/PLOS_Cleaning.R"))
```

Cleaning the PLOS data.
```{r}
PLOS_result <- clean_plos_data(file_path = here("data/RAW_PLOS.csv"), test = FALSE)

PLOS_Authors <- PLOS_result$author_data # Extracting cleaned PLOS data with author info.
PLOS_conflicts <- PLOS_result$name_conflicts # Extracting potential name conflicts.
```

Cleaning the PLOS comparator data.
```{r}
Comparator_result <- clean_plos_data(file_path = here("data/RAW_PLOS_Comparator.csv"), test = FALSE)

Comparator_Authors <- Comparator_result$author_data # Extracting cleaned PLOS data with author info.
Comparator_conflicts <- Comparator_result$name_conflicts # Extracting potential name conflicts.
```

Both conflicts dfs are empty, which is perfect! This means there are no middle name conflicts. Lets also clean the environment. 
```{r}
rm(PLOS_conflicts)
rm(PLOS_result)
rm(Comparator_conflicts)
rm(Comparator_result)
rm(clean_plos_data)
```

# NSERC Data

Load the NSERC cleaning function which can be found in the code directory.
```{r}
source(here("code/NSERC_Cleaning.R"))
```

Cleaning NSERC data.
```{r}
result_nserc <- clean_nserc_data(here("data/RAW_NSERC.csv"))

# Access different outputs:
NSERC_Summary <- result_nserc$summary_clean
NSERC_Summary_Conflicts <- result_nserc$summary_conflicts
```

Cleaning environment.
```{r}
rm(result_nserc)
rm(clean_nserc_data)
```

# CIHR Data

Load the CIHR cleaning function which can be found in the code directory.
```{r}
source(here("code/CIHR_Cleaning.R"))
```

Cleaning CIRH data.
```{r}
result_cihr <- clean_cihr_data(here("data/RAW_CIHR.csv"))

# Access different outputs:
CIHR_Summary <- result_cihr$summary_clean
CIHR_Summary_Conflicts <- result_cihr$summary_conflicts
```

Cleaning environment.
```{r}
rm(result_cihr)
rm(clean_cihr_data)
```

# Combining Data

Adding comparator data to the main PLOS data.
```{r}
Comparator_Authors <- Comparator_Authors %>% mutate(source = "Comparator") # Adding a column to distinguish rows from the comparator dataset.

PLOS_Authors <- bind_rows(PLOS_Authors, Comparator_Authors)
```

Adding main NSERC funding info to PLOS list.
```{r}
Author_Funding_Data <- left_join(PLOS_Authors, NSERC_Summary,
  by = c("first_name", "last_name")
)
```

Adding conflict NSERC funding info to PLOS list. Use middle name in the join.
```{r}
# First remove brackets and periods from middle names.
Author_Funding_Data$middle_name <- gsub("[().]", "", Author_Funding_Data$middle_name)
NSERC_Summary_Conflicts$middle_name <- gsub("[().]", "", NSERC_Summary_Conflicts$middle_name)

Author_Funding_Data <- Author_Funding_Data %>% 
  left_join(NSERC_Summary_Conflicts, by = c("first_name", "middle_name", "last_name")) %>%
  mutate(
    n_awards_NSERC = coalesce(n_awards_NSERC.x, 0) + coalesce(n_awards_NSERC.y, 0),
    total_amount_NSERC = coalesce(total_amount_NSERC.x, 0) + coalesce(total_amount_NSERC.y, 0),
    oldest_year_NSERC = pmin(oldest_year_NSERC.x, oldest_year_NSERC.y, na.rm = TRUE),
    newest_year_NSERC = pmax(newest_year_NSERC.x, newest_year_NSERC.y, na.rm = TRUE),
  ) %>%
  select(-n_awards_NSERC.x, -n_awards_NSERC.y, -total_amount_NSERC.x, -total_amount_NSERC.y, -oldest_year_NSERC.x, -oldest_year_NSERC.y, -newest_year_NSERC.x, -newest_year_NSERC.y)
```

Adding main CIHR data to PLOS list.
```{r}
Author_Funding_Data <- left_join(Author_Funding_Data, CIHR_Summary,
  by = c("first_name", "last_name")
)
```

Adding conflict CIHR funding info to PLOS list. Use middle name in the join.
```{r}
# First remove brackets and periods from middle names.
CIHR_Summary_Conflicts$middle_name <- gsub("[().]", "", CIHR_Summary_Conflicts$middle_name)

Author_Funding_Data <- Author_Funding_Data %>% 
  left_join(CIHR_Summary_Conflicts, by = c("first_name", "middle_name", "last_name")) %>%
  mutate(
    n_awards_CIHR = coalesce(n_awards_CIHR.x, 0) + coalesce(n_awards_CIHR.y, 0),
    total_amount_CIHR = coalesce(total_amount_CIHR.x, 0) + coalesce(total_amount_CIHR.y, 0),
    oldest_year_CIHR = pmin(oldest_year_CIHR.x, oldest_year_CIHR.y, na.rm = TRUE),
    newest_year_CIHR = pmax(newest_year_CIHR.x, newest_year_CIHR.y, na.rm = TRUE),
  ) %>%
  select(-n_awards_CIHR.x, -n_awards_CIHR.y, -total_amount_CIHR.x, -total_amount_CIHR.y, -oldest_year_CIHR.x, -oldest_year_CIHR.y, -newest_year_CIHR.x, -newest_year_CIHR.y)
```

Save data.
```{r}
# Isolate rows with funding info
Author_Funding_Data <- Author_Funding_Data %>%
  filter(n_awards_NSERC > 0 | n_awards_CIHR > 0)

# Save csv
write_csv(Author_Funding_Data, file = here("data/PLOS_Funding_Combined.csv"))
```

# Summary Stats

Load cleaned and combined data.
```{r}
Author_Funding_Data <- read.csv(here("data/PLOS_Funding_Combined.csv"))
```

How many unique authors do we have funding information for? How are they spread out between the PLOS and Comparator data sets.
```{r}
Author_Summary_Stats <- Author_Funding_Data %>%
  group_by(first_name, middle_name, last_name) %>%
  summarize(
    has_NA_source = any(is.na(source)),
    # ignore NA when testing for Comparator so any() returns TRUE/FALSE, not NA
    has_comp      = any(source == "Comparator", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  summarize(
    n_unique_authors = n(),
    pct_with_NA      = mean(has_NA_source) * 100,
    pct_with_comp    = mean(has_comp) * 100,
    pct_with_both    = mean(has_NA_source & has_comp) * 100
  )
```

Plot showing how many authors have multiple publications in the PLOL+Comparator data sets.
```{r}
Author_Funding_Data %>%
  group_by(first_name, middle_name, last_name) %>%
  summarize(n_rows = n(), .groups = "drop") %>%
  count(n_rows) %>%  # count how many authors have each n_rows
  ggplot(aes(x = n_rows, y = n)) +
  geom_col(fill = "skyblue", color = "black") +  # bars
  geom_text(aes(label = n), vjust = -0.3) +     # totals on top
  labs(
    x = "Number of Publications",
    y = "Author Count",
    title = "Distribution of Publications per Author"
  ) +
  theme_minimal()
```
