---
title: "Untitled"
format: html
---

## Libraries

First, we load our libraries.

```{r}
library(httr2)
library(rvest)
```

## Data

Read in a file that contains the redirect urls from the NSERC database. It assumed the column name containing the urls is called `url`. Sample these urls for testing purposes.

```{r}
data_file <- "../nserc-export_20260106_sample.csv"
dat <- read.csv(data_file)
sample_urls <- dat$url[sample(nrow(dat), 10, replace = FALSE)]
```

## Functions

### html request and server status

Fetch a url and check the headers, if the status code something other than 200, which means everything is ok, return the server error, otherwise return the html object.

```{r}
server_code <- function(query){
  resp <- httr2::request(query) |>
    httr2::req_perform()
  resp_code <- resp_status(resp)
  ifelse(resp_code != 200,
         return(resp_code),
         return(resp_body_html(resp)))
}
```

```{r}
get_award_details <- function(url_list, attribute) {
  counter <- 0
  
  awards_details <- list()
  
  for(i in 1:length(url_list)){
    if(counter != 0) {Sys.sleep(sample(c(1:10), 1))}
    counter <- counter + 1
    print(counter)
  
    query <- url_list[i]
    resp <- server_code(query = query)

    if (class(resp)[1] != "xml_document") {
      print("Not an html document")
      object_details <- list(
        server_code = resp,
        url = url_list[i]
      )
      awards_details[[i]] <- object_details
    } else {
      html_object <- resp |>
        html_element(attribute)
          if (!is.na(html_object)) {
          html_object <- html_object |>
            html_table()
          object_details <- list(
          variables = unlist(c(html_object[,1], html_object[-1,3])),
          values = unlist(c(html_object[,2], html_object[-1,4])),
          url = url_list[i]
          )
        } else {
          object_details <- list(
            issue = paste0("No html element with ", attribute, " found."),
            url = url_list[i]
          )
        }
      awards_details[[i]] <- object_details
    }
  }
    return(awards_details)
}
```

## Put it Together

```{r}
url_list <- sample_urls
attribute <- ".researchDetails"

output <- get_award_details(url_list = url_list, attribute = attribute)
```

## Sort out the Errors and Successes

We have three possible sets of responses:

1. Everything worked, we have a set of variables and values
2. We encountered a server error
3. We got some html back, but no table data

We'll split our list into three to investigate further

```{r}
awards_details <- Filter(function(x) names(x) == "values", output)
server_errors  <- Filter(function(x) names(x) == "server_code", output)
attriute_errors <- Filter(function(x) names(x) == "issue", output)
```

## Next steps

Figure out how to flatten things into a workable dataframe...